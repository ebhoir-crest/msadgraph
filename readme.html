<!-- File: readme.html
  Copyright (c) 2019 Splunk Inc.

  SPLUNK CONFIDENTIAL - Use or disclosure of this material in whole or in part
  without a valid written license from Splunk Inc. is PROHIBITED.
-->

<p>
<h2>Authentication</h2>
<br>
This app requires creating a Microsoft App Registration in Azure Portal. To do so, navigate to https://portal.azure.com in a browser and log in with a Microsoft account, then select <b>Azure Active Directory</b> from the left side menu.
<br><br>
On the next level menu just to the right of the first one, select <b>App Registrations</b>.
<br><br>
At the top of the middle section, select <b>New registration</b>.
<br><br>
Enter a name, select <b>Native</b> under application type and type <b>https://phantom.local</b> as a placeholder in the Redirect URI field.  You will update this later. Click somewhere else in the main screen to remove focus from the input fields and then click <b>Create</b> at the bottom of the window.
<br><br>
Once the app is created, click on the name of the app you just created in the middle section. From this screen, we will update two sections:
<ul>
    <li>Under <b>Redirect URIs</b> we will be updating the entry of https://phantom.local to reflect the actual redirect URI.  We will get this from the Phantom asset we create below in the section titled "Phantom asset for Azure"
    <li>Under <b>API Access</b> select required <b>Required Permissions</b> and then click where it says <b>Windows Azure Active Directory</b> with the permissions listed to the right. You will need to check the boxes next to the following permissions:
    <ul>
        <li>Access the directory as the signed-in user  (Required to change/reset user passwords)</li> 
        <li>Read directory data</li>
        <li>Read and write directory data</li>
        <li>Read all users' full profiles</li>
        <li>Sign in and read user profile</li>

    </ul>
</ul>
After adding these permissions, click <b>Save</b> at the top of the window.
<h2>Phantom Asset for Azure</h2>
When creating an asset for the <b>Azure AD Graph API</b> app, place <b>Application ID</b> of the app created during the previous step in the <b>Application ID</b> field.  Then, after filling out the <b>Tenant</b> field, click <b>SAVE</b>.
<br><br>
After saving, a new field will appear in the <b>Asset Settings</b> tab. Take the URL found in the <b>POST incoming for Azure AD Graph API to this location</b> field and place it in the <b>Redirect URIs</b> field mentioned above. To this URL, add <b>/result</b>. After doing so the URL should look something like:
<br><br>
<pre>
https://&lt;phantom_host&gt;/rest/handler/azureadgraph_c6d3b801-5c26-4abd-9e89-6d8007e2778f/&lt;asset_name&gt;/result
</pre>
<br>
Once again, click save at the top of the screen.
<h2>User Permissions</h2>
To complete the authorization process, this app needs permission to view assets, which is not granted by default. First, under <b>asset settings</b>, check which user is listed under <b>Select a user on behalf of which automated actions can be executed</b>. By default the user will be <b>automation</b>, but this user can be changed by clicking <b>EDIT</b> at the bottom of the window. To give this user permission to view assets, follow these steps:
<ul>
    <li>In the main drop-down menu, select <b>Administration</b>, then select the <b>User Management</b>, and under that tab, select <b>Roles</b>. Finally, click <b>+ ROLE</b>.</li>
    <li>In the <b>Add Role</b> wizard, give the role a name (e.g <b>Asset Viewer</b>), and provide a descrption. Subsequently, under <b>Available Users</b>, add the user assigned to the asset viewed earlier. Then click the <b>Permissions</b> tab.</li>
    <li>On the permission tab, under <b>Available Privileges</b>, give the role the <b>View Assets</b> privilege. Then click <b>SAVE</b>.</li>
</ul>
<h3>Test connectivity</h3>
After setting up the asset and user, click the <b>TEST CONNECTIVITY</b> button. A window should pop up and display a URL. Navigate to this URL in a separate browser tab. This new tab will redirect to a Microsoft login page. Log in to a Microsoft account with administrator privileges to the Azure AD environment. After logging in, review the requested permissions listed, then click <b>Accept</b>. Finally, close that tab. The test connectivity window should show success.
<br><br>
The app should now be ready to be used.
</p>
